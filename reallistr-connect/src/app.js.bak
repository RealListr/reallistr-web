import { KPITile } from './components/KPITile.js';
import { Table } from './components/Table.js';
import { store, initStore } from './store.js';
import { MAPBOX_TOKEN } from './config.js';
import './ai-stubs.js';

/* ---------- helpers ---------- */
const byId = (id)=>document.getElementById(id);
const toDataURL = (file)=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});
const ensureProp = (p)=>Object.assign({
  address:'', status:'draft', beds:0, baths:0, cars:0,
  ev_charger:false, solar:false, solar_watts:null, grass_type:'',
  land_m2:null, build_m2:null, level:null, pool:false,
  type:'House',
  listing_labels:[], listing_close_date:'',
  desc:'',
  media:{ images:[], videos:[], realcuts:[] },
  lat:null, lng:null
}, p||{});

/* ---------- inline pages ---------- */
const TPL = {
  '#/dashboard': `
    <h1 class="h1">Dashboard</h1>
    <div id="kpis" class="grid-3"></div>
    <div class="card" style="margin-top:16px">
      <div class="h2">My Properties</div>
      <div id="myProps"></div>
    </div>
  `,
  '#/subscriptions': `
    <h1 class="h1">Agent Subscription Tiers</h1>
    <div class="grid-3">
      <div class="card tier--starter"><div class="h2">Starter</div>
        <ul><li>Up to <b>10 properties</b></li><li>Basic AI assist</li><li>10 GB media</li><li>1 ad account</li></ul>
        <div class="cta"><button class="btn">Get Started</button></div></div>
      <div class="card tier--pro"><div class="h2">Pro</div>
        <ul><li><b>Unlimited properties</b></li><li>100 GB media</li><li>Up to 5 agents</li><li>Lead assignment</li></ul>
        <div class="cta"><button class="btn primary">Upgrade to Pro</button></div></div>
      <div class="card tier--enterprise"><div class="h2">Enterprise</div>
        <ul><li><b>Unlimited agents & offices</b></li><li>Priority AI</li><li>White-label</li></ul>
        <div class="cta"><button class="btn">Contact Sales</button></div></div>
    </div>
  `,
  '#/ads': `
    <h1 class="h1">Advertising Models</h1>
    <div class="grid-3">
      <div class="card ad--lite"><div class="h2">Lite</div><ul><li>1 campaign</li><li>Meta reach</li></ul><div class="cta"><button class="btn">Activate Lite</button></div></div>
      <div class="card ad--active"><div class="h2">Active</div><ul><li>Up to 5 campaigns</li><li>Meta + Google</li></ul><div class="cta"><button class="btn primary">Go Active</button></div></div>
      <div class="card ad--advanced"><div class="h2">Advanced</div><ul><li>Unlimited campaigns</li><li>Retargeting</li></ul><div class="cta"><button class="btn">Launch Advanced</button></div></div>
    </div>
  `,
  '#/properties': `
    <h1 class="h1">Properties</h1>
    <div class="card" style="margin-bottom:16px">
      <button class="btn" id="btnNewProp">+ New Property</button>
      <button class="btn" id="btnAIAdd">AI Quick Add (stub)</button>
    </div>
    <div id="propTable"></div>
  `,
  '#/leads': `<h1 class="h1">Leads</h1><div id="leadsTable"></div>`,
  '#/settings': `
    <h1 class="h1">Settings</h1>
    <div class="grid-2">
      <section class="card">
        <div class="h2">Subscription</div>
        <div id="plan"></div>
      </section>
      <section class="card">
        <div class="h2">Integrations</div>
        <p>Status: <span class="badge" id="adStatus">Not Connected</span></p>
        <button class="btn" id="btnConnect">Connect Ad Account (mock)</button>
      </section>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="h2">Team (Agents)</div>
      <div style="margin:8px 0">
        <button class="btn" id="btnAddAgent">+ Add Agent</button>
      </div>
      <div class="agent-grid" id="teamGrid"></div>
    </div>
    <div class="grid-2" style="margin-top:16px">
      <section class="card">
        <div class="h2">Agent Profile</div>
        <img id="agentAvatarPreview" class="avatar" alt="agent" />
        <div><input type="file" id="agentAvatar" accept="image/*"></div>
      </section>
      <section class="card">
        <div class="h2">Agency Branding</div>
        <img id="agencyAvatarPreview" class="avatar" alt="agency" />
        <div><input type="file" id="agencyAvatar" accept="image/*"></div>
      </section>
    </div>
  `,
  '#/property-editor': `
    <h1 class="h1">Property Editor</h1>
    <section class="card">
      <div class="grid-2">
        <div>
          <label>Address</label><br/>
          <input id="p_address" class="btn" style="width:100%" placeholder="123 Main St"/>
        </div>
        <div>
          <label>Status</label><br/>
          <select id="p_status" class="btn" style="width:100%">
            <option value="draft">Draft</option>
            <option value="published">Published</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div><label>Beds</label><br/><input id="p_beds" class="btn" type="number" min="0" style="width:100%"/></div>
        <div><label>Baths</label><br/><input id="p_baths" class="btn" type="number" min="0" style="width:100%"/></div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div><label>Car Spaces</label><br/><input id="p_cars" class="btn" type="number" min="0" style="width:100%"/></div>
        <div>
          <label>Pool</label><br/>
          <label><input type="checkbox" id="p_pool"/> Has pool</label>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div>
          <label>EV Charger</label><br/>
          <label><input type="checkbox" id="p_ev"/> Installed</label>
        </div>
        <div>
          <label>Solar</label><br/>
          <label><input type="checkbox" id="p_solar"/> Solar installed</label>
          <input id="p_solar_w" class="btn" type="number" min="0" placeholder="Wattage" style="width:100%;margin-top:6px"/>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div><label>Grass Type</label><br/><input id="p_grass" class="btn" style="width:100%" placeholder="Kikuyu/Buffalo/..."/></div>
        <div><label>Level (if apartment)</label><br/><input id="p_level" class="btn" type="number" min="0" style="width:100%"/></div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div><label>Land size (m²)</label><br/><input id="p_land" class="btn" type="number" min="0" step="0.1" style="width:100%"/></div>
        <div><label>Build area (m²)</label><br/><input id="p_build" class="btn" type="number" min="0" step="0.1" style="width:100%"/></div>
      </div>

      <div style="margin-top:12px">
        <label>Property Type</label><br/>
        <select id="p_type" class="btn" style="width:100%">
          ${[
            "House","Apartment","Unit","Townhouse","Granny Flat","Home + Granny Flat","Office",
            "Mixed use Commercial","Warehouse","Industrial Land","City Commercial Opportunity","Retail Shop","Car Park"
          ].map(t=>`<option value="${t}">${t}</option>`).join('')}
        </select>
      </div>

      <div style="margin-top:12px">
        <label>Listing Labels (multi-select)</label>
        <div id="labels" class="chips"></div>
        <div style="margin-top:8px"><input id="p_close" class="btn" placeholder="EOI/Auction close date (optional)" style="width:100%"/></div>
      </div>

      <div style="margin-top:12px">
        <label>Description</label><br/>
        <textarea id="p_desc" class="btn" style="width:100%;min-height:120px" placeholder="Short description..."></textarea>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <section>
          <div class="h2">Media</div>
          <div><b>Images</b> <input id="p_imgs" type="file" accept="image/*" multiple /></div>
          <div style="margin-top:6px"><b>Videos</b> <input id="p_vids" type="file" accept="video/*" multiple /></div>
          <div style="margin-top:6px"><b>RealCuts</b> <input id="p_cuts" type="file" accept="video/*" multiple /></div>
          <div id="p_media_preview" class="media-grid" style="margin-top:10px"></div>
        </section>
        <section>
          <div class="h2">Map</div>
          <div id="mapWrap" style="height:240px;border:1px solid #e5e7eb;border-radius:10px"></div>
          <div style="margin-top:8px">
            <input id="p_lat" class="btn" placeholder="lat" style="width:48%"/>
            <input id="p_lng" class="btn" placeholder="lng" style="width:48%;margin-left:4%"/>
          </div>
        </section>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn primary" id="p_save">Save</button>
        <button class="btn" id="p_cancel">Cancel</button>
      </div>
    </section>
  `
};

const LABEL_OPTIONS = [
  "Auction","For Sale","For Lease","Leasing","Pending Auction","Contact Agent",
  "Seeking Offers","Expression of Interest","Agency in Control","Lead Agency",
  "Private Sale","Private Treaty","Off Market"
];

/* ---------- router ---------- */
const routes = Object.keys(TPL);
const mount = async () => {
  const path = routes.includes(window.location.hash) ? window.location.hash : '#/dashboard';
  document.getElementById('app').innerHTML = TPL[path];
  attachControllers(path);
};

/* ---------- controllers ---------- */
function attachControllers(path){
  if(path === '#/dashboard'){
    const k = byId('kpis');
    k.innerHTML = [
      KPITile('Total Properties', store.properties.length),
      KPITile('Active Campaigns', store.campaigns.filter(c=>c.status==='active').length),
      KPITile('Leads', store.leads.length)
    ].join('');
    const rows = store.properties.slice(0,6).map(p=>[p.address||'-', p.status||'-', p.beds||0, p.baths||0]);
    byId('myProps').innerHTML = Table(['Address','Status','Beds','Baths'], rows);
  }

  if(path === '#/properties'){
    const draw = ()=>{
      const rows = store.properties.map((p,i)=>[
        p.address||'-', p.status||'-', p.beds||0, p.baths||0,
        `<button class="btn" data-edit="${i}">Edit</button>`
      ]);
      byId('propTable').innerHTML = Table(['Address','Status','Beds','Baths',''], rows);
      byId('propTable').querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick = ()=>{ localStorage.setItem('editIndex', btn.getAttribute('data-edit')); location.hash = '#/property-editor'; };
      });
    };
    draw();
    byId('btnNewProp').onclick = ()=>{
      store.properties.push(ensureProp({ status:'draft' })); store.persist();
      localStorage.setItem('editIndex', String(store.properties.length-1)); location.hash = '#/property-editor';
    };
    byId('btnAIAdd').onclick = ()=>{
      const ai = ensureProp(window.aiQuickAdd());
      store.properties.push(ai); store.persist();
      localStorage.setItem('editIndex', String(store.properties.length-1)); location.hash = '#/property-editor';
    };
  }

  if(path === '#/leads'){
    const rows = store.leads.map(l=>[l.name, l.property_id, l.stage, new Date(l.last_activity_at||Date.now()).toLocaleString()]);
    byId('leadsTable').innerHTML = Table(['Name','Property','Stage','Last Activity'], rows);
  }

  if(path === '#/settings'){
    const s = store.subscription || { plan:'starter', usage_props:0, usage_media_gb:0, ai_credits:0 };
    byId('plan').innerHTML = `Plan: <b>${s.plan}</b><br>Properties: ${s.usage_props} · Media: ${s.usage_media_gb} GB · AI credits: ${s.ai_credits}`;
    byId('btnConnect').onclick = ()=>{ const el = byId('adStatus'); el.textContent = 'Connected'; el.classList.add('badge--ok'); };

    // agent/agency main avatars
    const ag = byId('agentAvatarPreview'); const ay = byId('agencyAvatarPreview');
    if(ag) ag.src = store.agent.avatar || './public/assets/logo.svg';
    if(ay) ay.src = store.agency.avatar || './public/assets/icon-connect.svg';
    const up = async (input, target, assign)=>{ if(!input.files?.[0]) return; const data=await toDataURL(input.files[0]); target.src=data; assign(data); store.persist(); };
    byId('agentAvatar')?.addEventListener('change', e=>up(e.target, ag, d=>store.agent.avatar=d));
    byId('agencyAvatar')?.addEventListener('change', e=>up(e.target, ay, d=>store.agency.avatar=d));

    // team grid
    const renderTeam=()=>{
      const grid = byId('teamGrid'); grid.innerHTML='';
      store.team.forEach((m,idx)=>{
        const card=document.createElement('div'); card.className='agent-card';
        card.innerHTML = `
          <img class="avatar" src="${m.avatar||'./public/assets/logo.svg'}" />
          <div class="meta">
            <input type="text" value="${m.name||''}" placeholder="Agent name" />
            <div style="margin-top:6px">Followers:
              <input type="number" min="0" value="${m.followers||0}" style="width:120px"/>
            </div>
            <div style="margin-top:6px"><input type="file" accept="image/*"/></div>
          </div>
          <button class="btn" data-del="${idx}">Remove</button>`;
        grid.appendChild(card);
        const [nameI, followI, fileI] = card.querySelectorAll('input');
        nameI.oninput = ()=>{ m.name = nameI.value; store.persist(); };
        followI.oninput = ()=>{ m.followers = parseInt(followI.value||0,10); store.persist(); };
        fileI.onchange = async ()=>{ if(!fileI.files?.[0]) return; m.avatar = await toDataURL(fileI.files[0]); card.querySelector('img').src = m.avatar; store.persist(); };
        card.querySelector('[data-del]')?.addEventListener('click', ()=>{ store.team.splice(idx,1); store.persist(); renderTeam(); });
      });
    };
    renderTeam();
    byId('btnAddAgent').onclick = ()=>{ store.team.push({name:'New Agent', avatar:'', followers:0}); store.persist(); renderTeam(); };
  }

  if(path === '#/property-editor'){
    const idx = parseInt(localStorage.getItem('editIndex')||'-1',10);
    const p = store.properties[idx] = ensureProp(store.properties[idx]);

    // populate
    byId('p_address').value = p.address;
    byId('p_status').value  = p.status;
    byId('p_beds').value    = p.beds;
    byId('p_baths').value   = p.baths;
    byId('p_cars').value    = p.cars;
    byId('p_pool').checked  = !!p.pool;
    byId('p_ev').checked    = !!p.ev_charger;
    byId('p_solar').checked = !!p.solar;
    byId('p_solar_w').value = p.solar_watts ?? '';
    byId('p_grass').value   = p.grass_type || '';
    byId('p_level').value   = p.level ?? '';
    byId('p_land').value    = p.land_m2 ?? '';
    byId('p_build').value   = p.build_m2 ?? '';
    byId('p_type').value    = p.type || 'House';
    byId('p_desc').value    = p.desc || '';
    byId('p_lat').value     = p.lat ?? '';
    byId('p_lng').value     = p.lng ?? '';

    // labels
    const labelsEl = byId('labels');
    labelsEl.innerHTML = LABEL_OPTIONS.map(lbl=>{
      const active = p.listing_labels.includes(lbl) ? 'active':'';
      return `<div class="chip ${active}" data-lbl="${lbl}">${lbl}</div>`;
    }).join('');
    labelsEl.querySelectorAll('.chip').forEach(ch=>{
      ch.onclick = ()=>{ const v=ch.getAttribute('data-lbl'); const i=p.listing_labels.indexOf(v);
        if(i>=0){ p.listing_labels.splice(i,1); ch.classList.remove('active'); }
        else { p.listing_labels.push(v); ch.classList.add('active'); }
        store.persist();
      };
    });
    byId('p_close').value = p.listing_close_date || '';

    // media preview
    const preview = byId('p_media_preview');
    const refreshPreview = ()=>{
      preview.innerHTML='';
      (p.media.images||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; preview.appendChild(img); });
      (p.media.videos||[]).forEach(src=>{ const v=document.createElement('video'); v.src=src; v.controls=true; preview.appendChild(v); });
      (p.media.realcuts||[]).forEach(src=>{ const v=document.createElement('video'); v.src=src; v.controls=true; preview.appendChild(v); });
    };
    refreshPreview();

    const pushFiles = async (input, arrName)=>{
      const files = Array.from(input.files||[]);
      for(const f of files){ const data = await toDataURL(f); p.media[arrName].push(data); }
      store.persist(); refreshPreview();
    };
    byId('p_imgs').onchange = (e)=>pushFiles(e.target,'images');
    byId('p_vids').onchange = (e)=>pushFiles(e.target,'videos');
    byId('p_cuts').onchange = (e)=>pushFiles(e.target,'realcuts');

    // map
    const initMap = ()=>{
      if(!MAPBOX_TOKEN || !window.mapboxgl) return;
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const map = new mapboxgl.Map({container:'mapWrap', style:'mapbox://styles/mapbox/streets-v12', center:[p.lng||144.9631, p.lat||-37.8136], zoom:11});
      const marker = new mapboxgl.Marker({draggable:true}).setLngLat([p.lng||144.9631, p.lat||-37.8136]).addTo(map);
      marker.on('dragend', ()=>{ const ll=marker.getLngLat(); byId('p_lat').value=ll.lat.toFixed(6); byId('p_lng').value=ll.lng.toFixed(6); });
    };
    initMap();

    // solar wattage enable/disable on toggle
    const solarToggle = byId('p_solar'); const solarW = byId('p_solar_w');
    const syncSolar = ()=>{ solarW.disabled = !solarToggle.checked; if(!solarToggle.checked) solarW.value=""; };
    syncSolar();
    solarToggle.onchange = syncSolar;

    // save/cancel
    byId('p_save').onclick = ()=>{
      p.address = byId('p_address').value.trim();
      p.status  = byId('p_status').value;
      p.beds    = parseInt(byId('p_beds').value||0,10);
      p.baths   = parseInt(byId('p_baths').value||0,10);
      p.cars    = parseInt(byId('p_cars').value||0,10);
      p.pool    = !!byId('p_pool').checked;
      p.ev_charger = !!byId('p_ev').checked;
      p.solar   = !!byId('p_solar').checked;
      p.solar_watts = solarW.value ? parseInt(solarW.value,10) : null;
      p.grass_type  = byId('p_grass').value.trim();
      p.level   = byId('p_level').value ? parseInt(byId('p_level').value,10) : null;
      p.land_m2 = byId('p_land').value ? parseFloat(byId('p_land').value) : null;
      p.build_m2= byId('p_build').value ? parseFloat(byId('p_build').value) : null;
      p.type    = byId('p_type').value;
      p.desc    = byId('p_desc').value;
      p.listing_close_date = byId('p_close').value;
      p.lat     = byId('p_lat').value ? parseFloat(byId('p_lat').value) : null;
      p.lng     = byId('p_lng').value ? parseFloat(byId('p_lng').value) : null;

      store.properties[idx] = p; store.persist();
      alert('Saved'); location.hash = '#/properties';
    };
    byId('p_cancel').onclick = ()=>{ location.hash = '#/properties'; };
  }
}

/* ---------- boot ---------- */
window.addEventListener('hashchange', mount);
window.addEventListener('load', async()=>{ await initStore(); mount(); });

const sel = document.getElementById('roleSelect');
if(sel){ sel.value = localStorage.getItem('role') || 'principal'; sel.onchange = ()=>localStorage.setItem('role', sel.value); }
window.addEventListener('load', ()=>{
  const resetBtn = document.getElementById('btnReset');
  if(resetBtn){
    resetBtn.onclick = ()=>{ localStorage.removeItem('connectStore'); alert('Demo data has been reset. Refreshing...'); location.reload(); };
  }
});
