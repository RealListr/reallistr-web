<!doctype html>
<meta charset="utf-8">
<title>RealListr • Connect Centre (Lite)</title>
<style>
  :root { --border:#e5e7eb; --muted:#6b7280 }
  body { font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif; max-width:1100px; margin:32px auto; padding:0 16px }
  .card{border:1px solid var(--border); border-radius:12px; padding:16px; background:#fff}
  h1{margin:0 0 8px} .muted{color:var(--muted)}
  ul{list-style:none; margin:0; padding:0}
  li{padding:10px 12px; border:1px solid var(--border); border-radius:10px; margin:8px 0; display:flex; gap:8px; justify-content:space-between; align-items:center}
  .btn{padding:6px 10px; border:1px solid var(--border); border-radius:10px; text-decoration:none; color:inherit; background:#fff; cursor:pointer}
  .row{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
  .grow{flex:1 1 220px}
  input{width:100%; padding:10px; border:1px solid var(--border); border-radius:10px}
</style>

<h1>RealListr • Connect Centre</h1>
<p class="muted">Lite mode — no login, just data.</p>

<section class="card">
  <h2 style="margin:0 0 6px">Agents</h2>
  <p class="muted" style="margin:0 12px 10px 0">Quick edit</p>

  <!-- tiny edit/add form -->
  <div class="row">
    <input class="grow" id="f-address" placeholder="Address">
    <input class="grow" id="f-suburb"  placeholder="Suburb">
    <input style="width:120px" id="f-state" placeholder="State">
    <input style="width:160px" id="f-price" type="number" placeholder="Price">
  </div>
  <div class="row" style="margin-top:0">
    <input class="grow" id="f-id" placeholder="ID (auto if blank)">
    <button class="btn" id="btn-save">Save</button>
    <button class="btn" id="btn-clear">Clear</button>
  </div>

  <p class="muted" style="margin:12px 0 8px">Your current items</p>
  <div id="out">Loading…</div>
</section>

<script>
(async () => {
  const $ = (id)=>document.getElementById(id);
  const out = $('out');
  const fId=$('f-id'), fAddress=$('f-address'), fSuburb=$('f-suburb'), fState=$('f-state'), fPrice=$('f-price');

  $('btn-clear').onclick = () => [fId,fAddress,fSuburb,fState,fPrice].forEach(i=>i.value='');

  $('btn-save').onclick = async () => {
    const payload = {
      id: fId.value.trim() || undefined,
      address: fAddress.value.trim(),
      suburb: fSuburb.value.trim(),
      state: fState.value.trim(),
      price: fPrice.value ? Number(fPrice.value) : null
    };
    await fetch('/api/agents', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    $('btn-clear').click();
    await load();
  };

  async function load(){
    out.textContent = 'Loading…';
    const r = await fetch('/api/agents'); const list = await r.json();
    out.innerHTML = '<ul>' + list.map(p=>{
      const price = p.price!=null ? ' — $'+(p.price.toLocaleString?.() ?? p.price) : '';
      return `<li>
        <span>${p.address}, ${p.suburb}, ${p.state}${price}</span>
        <span>
          <a class="btn" href="/agent.html?id=${encodeURIComponent(p.id)}">View</a>
          <button class="btn" data-edit="${p.id}">Edit</button>
          <button class="btn" data-del="${p.id}">Delete</button>
        </span>
      </li>`;
    }).join('') + '</ul>';

    // wire edit/delete
    out.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = async () => {
        const id = b.getAttribute('data-edit');
        const one = await (await fetch('/api/agents/'+encodeURIComponent(id), {cache:'no-store'})).json();
        if (!one) return;
        fId.value=one.id||''; fAddress.value=one.address||''; fSuburb.value=one.suburb||''; fState.value=one.state||''; fPrice.value=one.price??'';
        window.scrollTo({ top: 0, behavior:'smooth' });
      };
    });
    out.querySelectorAll('[data-del]').forEach(b=>{
      b.onclick = async () => {
        const id = b.getAttribute('data-del');
        if (!confirm('Delete this property?')) return;
        await fetch('/api/agents/'+encodeURIComponent(id), { method:'DELETE' });
        await load();
      };
    });
  }

  // hash utils + prefill when arriving from “Edit in list”
  function parseHash(){
    const h=(location.hash||'').replace(/^#/,'');
    const [page, query] = h.split('?');
    return { page: page || 'agents', params: new URLSearchParams(query||'') };
  }
  (async function prefillFromHash(){
    const { page, params } = parseHash();
    if (page !== 'agents') return;
    const id = params.get('id'); if (!id) return;
    try{
      const one = await (await fetch('/api/agents/'+encodeURIComponent(id), {cache:'no-store'})).json();
      if (one && one.id){
        fId.value=one.id||''; fAddress.value=one.address||''; fSuburb.value=one.suburb||''; fState.value=one.state||''; fPrice.value=one.price??'';
        history.replaceState(null,'','/#agents'); window.scrollTo({ top:0, behavior:'smooth' });
      }
    }catch(e){ console.warn('prefill failed', e); }
  })();

  load();
})();
</script>
